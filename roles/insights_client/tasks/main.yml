---
#
#     Copyright 2018,2017 Red Hat, Inc
#
#     Licensed under the Apache License, Version 2.0 (the "License");
#     you may not use this file except in compliance with the License.
#     You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
#     Unless required by applicable law or agreed to in writing, software
#     distributed under the License is distributed on an "AS IS" BASIS,
#     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#     See the License for the specific language governing permissions and
#     limitations under the License.
#
- name: Install 'insights-client'
  ansible.builtin.yum:
    name: insights-client
  become: true
  notify: Run insights-client

- name: Set Insights Configuration Values
  insights_config:
    username: "{{ redhat_portal_username | default(omit) }}"
    password: "{{ redhat_portal_password | default(omit) }}"
    auto_config: "{{ auto_config | default(omit) }}"
    authmethod: "{{ authmethod | default(omit) }}"
    display_name: "{{ insights_display_name | default(omit) }}"
    proxy: "{{ insights_proxy | default(omit) }}"
    base_url: "{{ insights_base_url | default(omit) }}"
    auto_update: "{{ insights_auto_update | default(omit) }}"
    obfuscate: "{{ insights_obfuscate | default(omit) }}"
    obfuscate_hostname: "{{ insights_obfuscate_hostname | default(omit) }}"
    ansible_host: "{{ insights_ansible_host | default(omit) }}"
    cmd_timeout: "{{ insights_cmd_timeout | default(omit) }}"
    http_timeout: "{{ insights_http_timeout | default(omit) }}"
    core_collect: "{{ insights_core_collect | default(omit) }}"
    redaction_file: "{{ insights_redaction_file | default(omit) }}"
    content_redaction_file: "{{ insights_content_redaction_file | default(omit) }}"
    tags_file: "{{ insights_tags_file | default(omit) }}"
  become: true
  notify: Run insights-client

- name: Register Insights Client
  insights_register:
    state: present
  become: true

- name: Change permissions of Insights Config directory so that Insights System ID can be read
  ansible.builtin.file:
    path: /etc/insights-client
    mode: og=rx
  become: true

- name: Change permissions of machine_id file so that Insights System ID can be read
  ansible.builtin.file:
    path: /etc/insights-client/machine-id
    mode: og=r
  become: true
  notify: Run insights-client

- name: Create directory for ansible custom facts
  ansible.builtin.file:
    state: directory
    recurse: true
    path: /etc/ansible/facts.d
  become: true

- name: Install custom Insights fact
  ansible.builtin.copy:
    src: insights.fact
    dest: /etc/ansible/facts.d
    mode: a+x
  become: true
  notify: Run insights-client

- name: Slurp Insights config
  ansible.builtin.slurp:
    src: /etc/insights-client/insights-client.conf
  register: _insights_conf

- name: Set default tags_file path
  ansible.builtin.set_fact:
    _tags_file_path: /etc/insights-client/tags.yaml

- name: 'Handle tags_file present in the configuration file'
  when: >
    _insights_conf.content | b64decode |
    regex_findall('^(?<!#)\\s?tags_file\\s?=\\s?.+$', multiline=true)
  block:

    - name: Ensure only one configuration tags_file is present in the Insights configuration
      ansible.builtin.assert:
        that:
          - _insights_conf.content | b64decode |
            regex_findall('^(?<!#)\\s?tags_file\\s?=\\s?.+$', multiline=true) | length == 1
        success_msg: Only one tags_file configuration entry was found.
        fail_msg: >
          More than one tags_file configuration entry was found. Please check the Insights
          configuration on the host and correct this at /etc/insights-client/insights-client.conf

    - name: Ensure tags_file path does not contain equal signs
      ansible.builtin.assert:
        that:
          - _insights_conf.content |
            b64decode |
            regex_findall('^(?<!#)\\s?tags_file\\s?=\\s?.+$', multiline=true) |
            first |
            regex_findall('=') |
            length == 1
        success_msg: Path does not contain any equal signs.
        fail_msg: >
          Path contains one or more equal signs. Please check the option tags_file in the
          Insights client configuration at /etc/insights-client/insights-client.conf and
          correct this.

    - name: Override tags_file path with the path retrieved from the configuration file
      ansible.builtin.set_fact:
        _tags_file_path: >-
          {{
            _insights_conf.content |
            b64decode |
            regex_findall('^(?<!#)\s?tags_file\s?=\s?.+$', multiline=true) |
            first |
            split('=') |
            last |
            trim
          }}

- name: Debug Insights tags_file path set
  ansible.builtin.debug:
    var: _tags_file_path
    verbosity: 1

- name: Deploy Custom Tags
  ansible.builtin.copy:
    dest: "{{ _tags_file_path }}"
    content: "{{ insights_tags | to_nice_yaml }}"
    mode: og=r
  become: true
  when: insights_tags is defined
  notify: Run insights-client

- name: Remove Tags
  ansible.builtin.file:
    path: "{{ _tags_file_path }}"
    state: absent
  become: true
  when: insights_tags is not defined
  notify: Run insights-client
